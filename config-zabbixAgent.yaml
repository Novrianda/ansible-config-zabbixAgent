- name: Append Zabbix Server IP on Agent
  hosts: all
  become: yes

  vars:
    new_zabbix_ip: "10.10.10.12"

  handlers:
    - name: restart zabbix-agent
      service:
        name: zabbix-agent
        state: restarted

  tasks:

    - name: Ensure Server line exists
      lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: '^\s*Server\s*='
        line: "Server={{ new_zabbix_ip }}"
        insertafter: EOF
      register: server_line

    - name: Append IP if missing
      when: server_line.changed == false
      shell: |
        current=$(grep -E '^\s*Server\s*=' /etc/zabbix/zabbix_agentd.conf | cut -d= -f2)
        if ! echo "$current" | grep -qw "{{ new_zabbix_ip }}"; then
          new=$(echo "$current,{{ new_zabbix_ip }}" | tr -s ',' | sed 's/^,//')
          sed -i "s|^\s*Server\s*=.*|Server=$new|" /etc/zabbix/zabbix_agentd.conf
          echo changed
        fi
      register: append_result
      changed_when: "'changed' in append_result.stdout"
      notify: restart zabbix-agent